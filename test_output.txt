
> tunecamp@2.0.0 test /app
> node --experimental-vm-modules node_modules/jest/bin/jest.js

(node:2996) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
FAIL src/server/routes/activitypub.bench.test.ts
  ‚óè ActivityPub Outbox Performance ‚Ä∫ Benchmark N+1 vs Bulk Fetch

    Could not locate the bindings file. Tried:
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/build/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/build/Debug/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/build/Release/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/out/Debug/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/Debug/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/out/Release/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/Release/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/build/default/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/compiled/22.22.0/linux/x64/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/addon-build/release/install-root/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/addon-build/debug/install-root/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/addon-build/default/install-root/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/lib/binding/node-v127-linux-x64/better_sqlite3.node

      252 |
      253 | export function createDatabase(dbPath: string): DatabaseService {
    > 254 |     const db = new Database(dbPath);
          |                ^
      255 |
      256 |     // Enable WAL mode for better concurrency
      257 |     db.pragma("journal_mode = WAL");

      at bindings (node_modules/.pnpm/bindings@1.5.0/node_modules/bindings/bindings.js:126:9)
      at new Database (node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/lib/database.js:48:64)
      at createDatabase (src/server/database.ts:254:16)
      at Object.<anonymous> (src/server/routes/activitypub.bench.test.ts:15:21)


  ‚óè Test suite failed to run

    TypeError: Cannot read properties of undefined (reading 'db')

      60 |
      61 |     afterAll(() => {
    > 62 |         dbService.db.close();
         |                   ^
      63 |         if (fs.existsSync(DB_PATH)) {
      64 |             fs.unlinkSync(DB_PATH);
      65 |         }

      at Object.<anonymous> (src/server/routes/activitypub.bench.test.ts:62:19)

(node:2994) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
FAIL src/server/publishing.test.ts
  ‚óè PublishingService - Visibility Toggle ‚Ä∫ should call unregisterTracks when album visibility changes to private

    Could not locate the bindings file. Tried:
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/build/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/build/Debug/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/build/Release/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/out/Debug/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/Debug/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/out/Release/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/Release/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/build/default/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/compiled/22.22.0/linux/x64/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/addon-build/release/install-root/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/addon-build/debug/install-root/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/addon-build/default/install-root/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/lib/binding/node-v127-linux-x64/better_sqlite3.node

      252 |
      253 | export function createDatabase(dbPath: string): DatabaseService {
    > 254 |     const db = new Database(dbPath);
          |                ^
      255 |
      256 |     // Enable WAL mode for better concurrency
      257 |     db.pragma("journal_mode = WAL");

      at bindings (node_modules/.pnpm/bindings@1.5.0/node_modules/bindings/bindings.js:126:9)
      at new Database (node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/lib/database.js:48:64)
      at createDatabase (src/server/database.ts:254:16)
      at Object.<anonymous> (src/server/publishing.test.ts:22:14)

  ‚óè PublishingService - Visibility Toggle ‚Ä∫ should call unregisterTracks when album visibility changes to private

    TypeError: Cannot read properties of undefined (reading 'db')

      73 |
      74 |     afterEach(() => {
    > 75 |         db.db.close();
         |            ^
      76 |     });
      77 |
      78 |     test('should call unregisterTracks when album visibility changes to private', async () => {

      at Object.<anonymous> (src/server/publishing.test.ts:75:12)

  ‚óè PublishingService - Visibility Toggle ‚Ä∫ should call unregisterTracks when published_to_gundb is toggled off

    Could not locate the bindings file. Tried:
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/build/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/build/Debug/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/build/Release/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/out/Debug/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/Debug/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/out/Release/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/Release/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/build/default/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/compiled/22.22.0/linux/x64/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/addon-build/release/install-root/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/addon-build/debug/install-root/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/addon-build/default/install-root/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/lib/binding/node-v127-linux-x64/better_sqlite3.node

      252 |
      253 | export function createDatabase(dbPath: string): DatabaseService {
    > 254 |     const db = new Database(dbPath);
          |                ^
      255 |
      256 |     // Enable WAL mode for better concurrency
      257 |     db.pragma("journal_mode = WAL");

      at bindings (node_modules/.pnpm/bindings@1.5.0/node_modules/bindings/bindings.js:126:9)
      at new Database (node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/lib/database.js:48:64)
      at createDatabase (src/server/database.ts:254:16)
      at Object.<anonymous> (src/server/publishing.test.ts:22:14)

  ‚óè PublishingService - Visibility Toggle ‚Ä∫ should call unregisterTracks when published_to_gundb is toggled off

    TypeError: Cannot read properties of undefined (reading 'db')

      73 |
      74 |     afterEach(() => {
    > 75 |         db.db.close();
         |            ^
      76 |     });
      77 |
      78 |     test('should call unregisterTracks when album visibility changes to private', async () => {

      at Object.<anonymous> (src/server/publishing.test.ts:75:12)

(node:2995) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
FAIL src/server/auth.test.ts
  ‚óè Console

    console.log
      Hello wonderful person! :) Thanks for using GUN, please ask for help on http://chat.gun.eco if anything takes you longer than 5min to figure out!

      at Function.Gun.log (node_modules/.pnpm/gun@0.2020.1241/node_modules/gun/gun.js:542:55)

  ‚óè AuthService ‚Ä∫ init creates default admin

    Could not locate the bindings file. Tried:
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/build/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/build/Debug/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/build/Release/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/out/Debug/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/Debug/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/out/Release/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/Release/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/build/default/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/compiled/22.22.0/linux/x64/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/addon-build/release/install-root/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/addon-build/debug/install-root/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/addon-build/default/install-root/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/lib/binding/node-v127-linux-x64/better_sqlite3.node

       8 |
       9 |     beforeEach(async () => {
    > 10 |         db = new Database(":memory:");
         |              ^
      11 |         authService = createAuthService(db, "secret");
      12 |         await authService.init();
      13 |     });

      at bindings (node_modules/.pnpm/bindings@1.5.0/node_modules/bindings/bindings.js:126:9)
      at new Database (node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/lib/database.js:48:64)
      at Object.<anonymous> (src/server/auth.test.ts:10:14)

  ‚óè AuthService ‚Ä∫ init creates default admin

    TypeError: Cannot read properties of undefined (reading 'close')

      14 |
      15 |     afterEach(() => {
    > 16 |         db.close();
         |            ^
      17 |     });
      18 |
      19 |     test("init creates default admin", async () => {

      at Object.<anonymous> (src/server/auth.test.ts:16:12)

  ‚óè AuthService ‚Ä∫ isDefaultPassword returns true for default admin

    Could not locate the bindings file. Tried:
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/build/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/build/Debug/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/build/Release/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/out/Debug/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/Debug/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/out/Release/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/Release/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/build/default/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/compiled/22.22.0/linux/x64/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/addon-build/release/install-root/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/addon-build/debug/install-root/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/addon-build/default/install-root/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/lib/binding/node-v127-linux-x64/better_sqlite3.node

       8 |
       9 |     beforeEach(async () => {
    > 10 |         db = new Database(":memory:");
         |              ^
      11 |         authService = createAuthService(db, "secret");
      12 |         await authService.init();
      13 |     });

      at bindings (node_modules/.pnpm/bindings@1.5.0/node_modules/bindings/bindings.js:126:9)
      at new Database (node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/lib/database.js:48:64)
      at Object.<anonymous> (src/server/auth.test.ts:10:14)

  ‚óè AuthService ‚Ä∫ isDefaultPassword returns true for default admin

    TypeError: Cannot read properties of undefined (reading 'close')

      14 |
      15 |     afterEach(() => {
    > 16 |         db.close();
         |            ^
      17 |     });
      18 |
      19 |     test("init creates default admin", async () => {

      at Object.<anonymous> (src/server/auth.test.ts:16:12)

  ‚óè AuthService ‚Ä∫ isDefaultPassword returns false for changed password

    Could not locate the bindings file. Tried:
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/build/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/build/Debug/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/build/Release/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/out/Debug/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/Debug/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/out/Release/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/Release/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/build/default/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/compiled/22.22.0/linux/x64/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/addon-build/release/install-root/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/addon-build/debug/install-root/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/addon-build/default/install-root/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/lib/binding/node-v127-linux-x64/better_sqlite3.node

       8 |
       9 |     beforeEach(async () => {
    > 10 |         db = new Database(":memory:");
         |              ^
      11 |         authService = createAuthService(db, "secret");
      12 |         await authService.init();
      13 |     });

      at bindings (node_modules/.pnpm/bindings@1.5.0/node_modules/bindings/bindings.js:126:9)
      at new Database (node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/lib/database.js:48:64)
      at Object.<anonymous> (src/server/auth.test.ts:10:14)

  ‚óè AuthService ‚Ä∫ isDefaultPassword returns false for changed password

    TypeError: Cannot read properties of undefined (reading 'close')

      14 |
      15 |     afterEach(() => {
    > 16 |         db.close();
         |            ^
      17 |     });
      18 |
      19 |     test("init creates default admin", async () => {

      at Object.<anonymous> (src/server/auth.test.ts:16:12)

  ‚óè AuthService ‚Ä∫ isDefaultPassword returns false for non-existent user

    Could not locate the bindings file. Tried:
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/build/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/build/Debug/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/build/Release/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/out/Debug/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/Debug/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/out/Release/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/Release/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/build/default/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/compiled/22.22.0/linux/x64/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/addon-build/release/install-root/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/addon-build/debug/install-root/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/addon-build/default/install-root/better_sqlite3.node
     ‚Üí /app/node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/lib/binding/node-v127-linux-x64/better_sqlite3.node

       8 |
       9 |     beforeEach(async () => {
    > 10 |         db = new Database(":memory:");
         |              ^
      11 |         authService = createAuthService(db, "secret");
      12 |         await authService.init();
      13 |     });

      at bindings (node_modules/.pnpm/bindings@1.5.0/node_modules/bindings/bindings.js:126:9)
      at new Database (node_modules/.pnpm/better-sqlite3@12.6.2/node_modules/better-sqlite3/lib/database.js:48:64)
      at Object.<anonymous> (src/server/auth.test.ts:10:14)

  ‚óè AuthService ‚Ä∫ isDefaultPassword returns false for non-existent user

    TypeError: Cannot read properties of undefined (reading 'close')

      14 |
      15 |     afterEach(() => {
    > 16 |         db.close();
         |            ^
      17 |     });
      18 |
      19 |     test("init creates default admin", async () => {

      at Object.<anonymous> (src/server/auth.test.ts:16:12)

PASS src/utils/networkUtils.test.ts
PASS src/server/routes/admin.test.ts
  ‚óè Console

    console.log
      üåê Re-registered site and tracks on GunDB with updated settings: http://localhost

      at src/server/routes/admin.ts:196:25

PASS src/server/routes/upload.test.ts
  ‚óè Console

    console.log
      üîç [Debug] Upload Request Headers: multipart/form-data; boundary=--------------------------2d6c36599a127f39ffe07a4d

      at src/server/routes/upload.ts:192:17

    console.log
      üîç [Debug] Multer fileFilter seeing file: file (test-image.jpg)

      at fileFilter (src/server/routes/upload.ts:42:13)

    console.log
      üìÇ [Debug] Multer destination: /tmp

      at DiskStorage.destination [as getDestination] (src/server/routes/upload.ts:20:21)

    console.log
      üìÑ [Debug] Multer filename: file-1771437553388-844259054.jpg

      at DiskStorage.filename [as getFilename] (src/server/routes/upload.ts:28:21)

    console.log
      üîç [Debug] Inside /cover handler

      at src/server/routes/upload.ts:196:21

    console.log
      üîç [Debug] req.file: test-image.jpg (18 bytes)

      at src/server/routes/upload.ts:197:21

    console.log
      üîç [Debug] req.body: [Object: null prototype] { releaseSlug: '../' }

      at src/server/routes/upload.ts:198:21

    console.log
      üé® Uploaded cover: test-image.jpg

      at src/server/routes/upload.ts:208:21

    console.log
      üîç [Debug] Upload Request Headers: multipart/form-data; boundary=--------------------------9313d6c91854c3ae3ac97c4d

      at src/server/routes/upload.ts:192:17

    console.log
      üîç [Debug] Multer fileFilter seeing file: file (valid.jpg)

      at fileFilter (src/server/routes/upload.ts:42:13)

    console.log
      üìÇ [Debug] Multer destination: /tmp

      at DiskStorage.destination [as getDestination] (src/server/routes/upload.ts:20:21)

    console.log
      üìÑ [Debug] Multer filename: file-1771437553411-723831681.jpg

      at DiskStorage.filename [as getFilename] (src/server/routes/upload.ts:28:21)

    console.log
      üîç [Debug] Inside /cover handler

      at src/server/routes/upload.ts:196:21

    console.log
      üîç [Debug] req.file: valid.jpg (19 bytes)

      at src/server/routes/upload.ts:197:21

    console.log
      üîç [Debug] req.body: [Object: null prototype] { releaseSlug: 'valid-album' }

      at src/server/routes/upload.ts:198:21

    console.log
      üé® Uploaded cover: valid.jpg

      at src/server/routes/upload.ts:208:21

    console.log
         Moved cover to: /tmp/tunecamp-test-6JiF8z/releases/valid-album/artwork/cover-1771437553415.jpg

      at src/server/routes/upload.ts:239:25

    console.log
      üìÄ Updated cover for album Valid Album -> releases/valid-album/artwork/cover-1771437553415.jpg

      at src/server/routes/upload.ts:259:29

    console.log
      ‚úÖ Cover upload completed: valid.jpg

      at src/server/routes/upload.ts:290:21

PASS src/server/routes/upload_security.test.ts
  ‚óè Console

    console.log
      üîç [Debug] Multer fileFilter seeing file: files (test.mp3)

      at fileFilter (src/server/routes/upload.ts:42:13)

    console.log
      üìÇ [Debug] Multer destination: /tmp

      at DiskStorage.destination [as getDestination] (src/server/routes/upload.ts:20:21)

    console.log
      üìÑ [Debug] Multer filename: files-1771437553747-209737752.mp3

      at DiskStorage.filename [as getFilename] (src/server/routes/upload.ts:28:21)

    console.log
      üì§ Upload received: 1 track(s)

      at src/server/routes/upload.ts:103:21

    console.log
         - test.mp3: 0.00 MB

      at src/server/routes/upload.ts:104:40
          at Array.forEach (<anonymous>)

    console.log
         Target Release Slug: other-artist-album

      at src/server/routes/upload.ts:106:25

    console.warn
      ‚õî Access Denied: User undefined (Artist 1) tried to upload to release other-artist-album (Artist 2)

      115 |             // SECURITY FIX: Prevent uploading to another artist's release
      116 |             if (release && (req as any).artistId && release.artist_id !== (req as any).artistId) {
    > 117 |                 console.warn(`‚õî Access Denied: User ${(req as any).username} (Artist ${(req as any).artistId}) tried to upload to release ${release.slug} (Artist ${release.artist_id})`);
          |                         ^
      118 |                 // Cleanup temp files
      119 |                 for (const file of files) {
      120 |                     await fs.remove(file.path).catch(() => {});

      at src/server/routes/upload.ts:117:25
      at Layer.handle [as handle_request] (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/route.js:149:13)
      at done (node_modules/.pnpm/multer@2.0.2/node_modules/multer/lib/make-middleware.js:59:7)
      at indicateDone (node_modules/.pnpm/multer@2.0.2/node_modules/multer/lib/make-middleware.js:63:68)
      at node_modules/.pnpm/multer@2.0.2/node_modules/multer/lib/make-middleware.js:176:11
      at WriteStream.<anonymous> (node_modules/.pnpm/multer@2.0.2/node_modules/multer/storage/disk.js:43:9)

    console.log
      ‚úÖ Security check passed: Upload blocked due to artist mismatch.

      at Object.<anonymous> (src/server/routes/upload_security.test.ts:85:22)

PASS src/server/routes/backup.test.ts
  ‚óè Console

    console.log
      üì¶ [Restore] Assembling 2 chunks...

      at src/server/routes/backup.ts:339:29

    console.log
      üì¶ [Restore] Extracting backup...

      at performRestore (src/server/routes/backup.ts:20:17)

    console.error
      ‚ùå [Restore] Failed: Error: ADM-ZIP: Invalid or unsupported zip format. No END header found
          at Object.INVALID_FORMAT (/app/node_modules/.pnpm/adm-zip@0.5.16/node_modules/adm-zip/util/errors.js:56:16)
          at readMainHeader (/app/node_modules/.pnpm/adm-zip@0.5.16/node_modules/adm-zip/zipFile.js:123:49)
          at new Object.<anonymous>.module.exports (/app/node_modules/.pnpm/adm-zip@0.5.16/node_modules/adm-zip/zipFile.js:21:9)
          at new Object.<anonymous>.module.exports (/app/node_modules/.pnpm/adm-zip@0.5.16/node_modules/adm-zip/adm-zip.js:67:18)
          at performRestore (/app/src/server/routes/backup.ts:24:21)
          at /app/src/server/routes/backup.ts:356:21

      117 |
      118 |     } catch (error: any) {
    > 119 |         console.error("‚ùå [Restore] Failed:", error);
          |                 ^
      120 |     } finally {
      121 |         // Cleanup
      122 |         // Use Promise API for fs-extra to allow .catch() or just suppress error in callback

      at performRestore (src/server/routes/backup.ts:119:17)
      at src/server/routes/backup.ts:356:21

PASS src/server/password_security.test.ts
PASS src/server/routes/browser.test.ts
PASS src/server/routes/releases.test.ts
PASS src/server/config.test.ts
PASS src/server/error-handling.test.ts
  ‚óè Console

    console.log
      Hello wonderful person! :) Thanks for using GUN, please ask for help on http://chat.gun.eco if anything takes you longer than 5min to figure out!

      at Function.Gun.log (node_modules/.pnpm/gun@0.2020.1241/node_modules/gun/gun.js:542:55)

    console.error
      üî• Global error: Error: Database connection failed: user=postgres password=secret host=10.0.0.1
          at /app/src/server/error-handling.test.ts:26:27
          at Layer.handle [as handle_request] (/app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/layer.js:95:5)
          at next (/app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/route.js:149:13)
          at Route.dispatch (/app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/route.js:119:3)
          at Layer.handle [as handle_request] (/app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/layer.js:95:5)
          at /app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:284:15
          at Function.process_params (/app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:346:12)
          at next (/app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:280:10)
          at expressInit (/app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/middleware/init.js:40:5)
          at Layer.handle [as handle_request] (/app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/layer.js:95:5)
          at trim_prefix (/app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:328:13)
          at /app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:286:9
          at Function.process_params (/app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:346:12)
          at next (/app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:280:10)
          at query (/app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/middleware/query.js:45:5)
          at Layer.handle [as handle_request] (/app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/layer.js:95:5)
          at trim_prefix (/app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:328:13)
          at /app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:286:9
          at Function.process_params (/app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:346:12)
          at next (/app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:280:10)
          at Function.handle (/app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:175:3)
          at Function.handle (/app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/application.js:181:10)
          at Server.app (/app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/express.js:39:9)
          at Server.emit (node:events:519:28)
          at parserOnIncoming (node:_http_server:1186:12)
          at HTTPParser.parserOnHeadersComplete (node:_http_common:122:17)

      376 |
      377 | export const globalErrorHandler = (err: any, req: express.Request, res: express.Response, next: express.NextFunction) => {
    > 378 |     console.error("üî• Global error:", err);
          |             ^
      379 |     if (res.headersSent) {
      380 |         return next(err);
      381 |     }

      at globalErrorHandler (src/server/server.ts:378:13)
      at Layer.handle_error (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:326:13)
      at node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:280:10)
      at next (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/route.js:141:14)
      at src/server/error-handling.test.ts:27:13
      at Layer.handle [as handle_request] (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/layer.js:95:5)
      at node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:284:15
      at Function.process_params (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:280:10)
      at expressInit (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/middleware/init.js:40:5)
      at Layer.handle [as handle_request] (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:328:13)
      at node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:280:10)
      at query (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/middleware/query.js:45:5)
      at Layer.handle [as handle_request] (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:328:13)
      at node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:280:10)
      at Function.handle (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:175:3)
      at Function.handle (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/application.js:181:10)
      at Server.app (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/express.js:39:9)

    console.error
      üî• Global error: Error: Database connection failed: user=postgres password=secret host=10.0.0.1
          at /app/src/server/error-handling.test.ts:26:27
          at Layer.handle [as handle_request] (/app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/layer.js:95:5)
          at next (/app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/route.js:149:13)
          at Route.dispatch (/app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/route.js:119:3)
          at Layer.handle [as handle_request] (/app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/layer.js:95:5)
          at /app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:284:15
          at Function.process_params (/app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:346:12)
          at next (/app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:280:10)
          at expressInit (/app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/middleware/init.js:40:5)
          at Layer.handle [as handle_request] (/app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/layer.js:95:5)
          at trim_prefix (/app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:328:13)
          at /app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:286:9
          at Function.process_params (/app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:346:12)
          at next (/app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:280:10)
          at query (/app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/middleware/query.js:45:5)
          at Layer.handle [as handle_request] (/app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/layer.js:95:5)
          at trim_prefix (/app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:328:13)
          at /app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:286:9
          at Function.process_params (/app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:346:12)
          at next (/app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:280:10)
          at Function.handle (/app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:175:3)
          at Function.handle (/app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/application.js:181:10)
          at Server.app (/app/node_modules/.pnpm/express@4.22.1/node_modules/express/lib/express.js:39:9)
          at Server.emit (node:events:519:28)
          at parserOnIncoming (node:_http_server:1186:12)
          at HTTPParser.parserOnHeadersComplete (node:_http_common:122:17)

      376 |
      377 | export const globalErrorHandler = (err: any, req: express.Request, res: express.Response, next: express.NextFunction) => {
    > 378 |     console.error("üî• Global error:", err);
          |             ^
      379 |     if (res.headersSent) {
      380 |         return next(err);
      381 |     }

      at globalErrorHandler (src/server/server.ts:378:13)
      at Layer.handle_error (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:326:13)
      at node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:280:10)
      at next (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/route.js:141:14)
      at src/server/error-handling.test.ts:27:13
      at Layer.handle [as handle_request] (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/layer.js:95:5)
      at node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:284:15
      at Function.process_params (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:280:10)
      at expressInit (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/middleware/init.js:40:5)
      at Layer.handle [as handle_request] (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:328:13)
      at node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:280:10)
      at query (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/middleware/query.js:45:5)
      at Layer.handle [as handle_request] (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:328:13)
      at node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:280:10)
      at Function.handle (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/router/index.js:175:3)
      at Function.handle (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/application.js:181:10)
      at Server.app (node_modules/.pnpm/express@4.22.1/node_modules/express/lib/express.js:39:9)

PASS src/server/middleware/rateLimit.test.ts
PASS src/utils/stringUtils.test.ts
PASS src/server/middleware/security.test.ts

Test Suites: 3 failed, 13 passed, 16 total
Tests:       7 failed, 48 passed, 55 total
Snapshots:   0 total
Time:        6.761 s, estimated 10 s
Ran all test suites.
‚ÄâELIFECYCLE‚Äâ Test failed. See above for more details.
