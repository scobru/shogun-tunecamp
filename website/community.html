<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tunecamp Community - Discover Independent Music</title>
    <meta name="description"
        content="Discover independent artists using Tunecamp. A decentralized community directory of music websites.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Community-specific styles */
        .sites-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: var(--space-lg);
            margin: var(--space-xl) 0;
        }

        .site-card {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .site-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .site-card-cover {
            height: 180px;
            background: linear-gradient(135deg, var(--accent), var(--accent-hover));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3rem;
        }

        .site-card-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .site-card-content {
            padding: var(--space-lg);
        }

        .site-card h3 {
            font-size: 1rem;
            margin-bottom: var(--space-xs);
            font-weight: 600;
        }

        .site-card h3 a {
            color: var(--text-primary);
            text-decoration: none;
        }

        .site-card h3 a:hover {
            color: var(--accent);
        }

        .site-card .artist {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: var(--space-sm);
        }

        .site-card .meta {
            font-size: 0.75rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .live-dot {
            width: 6px;
            height: 6px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .status-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-md);
            background: var(--bg-surface-alt);
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: var(--space-xl);
        }

        .status-bar .live {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            font-size: 0.875rem;
            color: #10b981;
        }

        .sites-count {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .empty-state {
            text-align: center;
            padding: var(--space-3xl);
            color: var(--text-muted);
        }

        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: var(--space-lg);
        }

        .cta-section {
            background: var(--accent);
            color: white;
            padding: var(--space-xl);
            border-radius: 8px;
            text-align: center;
            margin: var(--space-2xl) 0;
        }

        .cta-section h3 {
            color: white;
            margin-bottom: var(--space-sm);
        }

        .cta-section p {
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: var(--space-lg);
        }

        .cta-section .btn {
            background: white;
            color: var(--accent);
        }

        .cta-section .btn:hover {
            background: #f0f0f0;
        }
    </style>
</head>

<body>
    <div class="container">
        <header style="border-bottom: none; padding-bottom: var(--space-lg);">
            <p style="margin-bottom: var(--space-lg);"><a href="index.html"
                    style="color: var(--text-muted); font-size: 0.875rem;">‚Üê Back to Tunecamp</a></p>
            <h1>üåê Community</h1>
            <p class="subtitle">Discover independent artists using Tunecamp</p>

            <div class="download-buttons">
                <a href="player.html" class="btn">üéµ Listen Now</a>
                <a href="index.html" class="btn btn-secondary">Get Tunecamp</a>
            </div>
        </header>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="live">
                <span class="live-dot"></span>
                Live updates
            </div>
            <div class="sites-count" id="countDisplay">Loading...</div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('sites')">Instances</div>
            <div class="tab" onclick="switchTab('tracks')">Tracks</div>
        </div>

        <!-- Sites Grid -->
        <div class="sites-grid" id="sitesGrid">
            <div class="empty-state">
                <div class="icon">‚è≥</div>
                <p>Connecting to the network...</p>
            </div>
        </div>

        <!-- Tracks Grid -->
        <div class="tracks-grid hidden" id="tracksGrid">
            <div class="empty-state">
                <div class="icon">‚è≥</div>
                <p>Scanning for tracks...</p>
            </div>
        </div>

        <!-- CTA -->
        <div class="cta-section">
            <h3>üéµ Join the Community</h3>
            <p>Your Tunecamp site is automatically registered when visitors browse it.<br>
                No sign-up needed ‚Äî it's fully decentralized via GunDB.</p>
            <a href="player.html" class="btn" style="margin-right: 10px;">üéµ Listen Now</a>
            <a href="index.html" class="btn">Get Started</a>
        </div>

        <footer>
            <div class="footer-links">
                <a href="https://github.com/scobru/tunecamp">GitHub</a>
                <a href="https://www.npmjs.com/package/tunecamp">NPM</a>
                <a href="player.html">üéµ Player</a>
                <a href="index.html">Home</a>
                <a href="https://buymeacoffee.com/scobru" target="_blank">‚òï Support</a>
            </div>
            <div class="footer-note">
                Powered by GunDB. Made with ‚ù§Ô∏è by <a href="https://github.com/scobru" target="_blank">scobru</a>
            </div>
        </footer>
    </div>

    <!-- GunDB -->
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
    <script>
        const REGISTRY_PEERS = [
            'https://gun.defucc.me/gun',
            'https://gun.o8.is/gun',
            'https://shogun-relay.scobrudot.dev/gun',
            'https://relay.peer.ooo/gun',
        ];
        const REGISTRY_ROOT = 'shogun';
        const REGISTRY_NAMESPACE = 'tunecamp-community';

        const gun = Gun({ peers: REGISTRY_PEERS, localStorage: true });

        // Data Stores
        const sitesMap = new Map();
        const tracksMap = new Map();
        let currentTab = 'sites';

        // --- Tabs Logic ---
        function switchTab(tab) {
            currentTab = tab;

            // UI Updates
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).classList.add('active');

            const sitesGrid = document.getElementById('sitesGrid');
            const tracksGrid = document.getElementById('tracksGrid');

            if (tab === 'sites') {
                sitesGrid.classList.remove('hidden');
                tracksGrid.classList.add('hidden');
                updateCountDisplay();
            } else {
                sitesGrid.classList.add('hidden');
                tracksGrid.classList.remove('hidden');
                updateCountDisplay();
            }
        }

        function updateCountDisplay() {
            const countDisplay = document.getElementById('countDisplay');
            if (currentTab === 'sites') {
                const count = document.querySelectorAll('.site-card').length;
                countDisplay.textContent = `${count} instance${count !== 1 ? 's' : ''}`;
            } else {
                const count = document.querySelectorAll('.track-card').length;
                countDisplay.textContent = `${count} track${count !== 1 ? 's' : ''}`;
            }
        }

        // --- Discovery Logic ---
        function initDiscovery() {
            const processedIds = new Set();

            gun.get(REGISTRY_ROOT)
                .get(REGISTRY_NAMESPACE)
                .get('sites')
                .map()
                .on((directoryData, siteId) => {
                    if (!directoryData || siteId === "_") return;
                    if (processedIds.has(siteId)) return;
                    processedIds.add(siteId);

                    // Skip localhost/invalid sites immediately (server logic)
                    if (!isValidUrl(directoryData.url)) return;

                    // 1. Secure Mode: Read from user graph if pub key is available
                    if (directoryData.pub) {
                        gun.user(directoryData.pub)
                            .get('tunecamp')
                            .get('profile')
                            .once((profileData) => {
                                if (profileData) {
                                    // Authoritative Site Info
                                    const siteInfo = normalizeSiteData(siteId, profileData, true);
                                    if (validateSite(siteInfo)) {
                                        sitesMap.set(siteId, siteInfo);
                                        renderSites();

                                        // Scan Tracks from Secure Graph
                                        scanSecureTracks(directoryData.pub, siteInfo);
                                    }
                                } else {
                                    // Fallback to directory
                                    processLegacySite(siteId, directoryData);
                                }
                            });
                    } else {
                        // 2. Legacy Mode: Use directory data directly
                        processLegacySite(siteId, directoryData);
                    }
                });

            // Timeout to show empty states
            setTimeout(() => {
                if (sitesMap.size === 0) showEmptyState('sitesGrid', 'No sites found yet.');
                if (tracksMap.size === 0) showEmptyState('tracksGrid', 'No tracks found yet.');
            }, 5000);
        }

        function processLegacySite(siteId, data) {
            const siteInfo = normalizeSiteData(siteId, data, false);
            if (validateSite(siteInfo)) {
                sitesMap.set(siteId, siteInfo);
                renderSites();

                // Scan Tracks from Public Directory (Legacy)
                scanLegacyTracks(siteId, siteInfo);
            }
        }

        function scanSecureTracks(pub, siteInfo) {
            gun.user(pub)
                .get('tunecamp')
                .get('tracks')
                .map()
                .once((trackData, slug) => {
                    if (trackData && slug !== "_") {
                        processTrack(trackData, slug, siteInfo, true);
                    }
                });
        }

        function scanLegacyTracks(siteId, siteInfo) {
            gun.get(REGISTRY_ROOT)
                .get(REGISTRY_NAMESPACE)
                .get('sites')
                .get(siteId)
                .get('tracks')
                .map()
                .once((trackData, slug) => {
                    if (trackData && slug !== "_") {
                        processTrack(trackData, slug, siteInfo, false);
                    }
                });
        }

        function processTrack(data, slug, siteInfo, isSecure) {
             if (!data || !data.title) return;

             // Strict Validation
             if (!data.audioUrl && !data.streamUrl) return; // Must have audio

             const track = {
                 id: slug,
                 title: data.title,
                 artistName: data.artistName || siteInfo.artistName || "Unknown Artist",
                 albumName: data.releaseTitle || "Unknown Album",
                 coverUrl: data.coverUrl || siteInfo.coverImage,
                 audioUrl: data.audioUrl || data.streamUrl,
                 duration: data.duration || 0,
                 siteUrl: siteInfo.url,
                 siteTitle: siteInfo.title,
                 addedAt: data.addedAt || Date.now(),
                 _secure: isSecure
             };

             // URL Sanitization
             if (!isValidUrl(track.audioUrl)) return;

             // Add to map
             // Unique key: siteUrl + trackSlug
             const uniqueKey = `${siteInfo.url}::${slug}`;
             tracksMap.set(uniqueKey, track);

             renderTracks();
        }

        // --- Helpers ---

        function isValidUrl(url) {
            if (!url) return false;
            if (url.includes('localhost') || url.includes('127.0.0.1') || url.startsWith('file://')) return false;
            return url.startsWith('http');
        }

        function normalizeSiteData(id, data, isSecure) {
            return {
                id: id,
                url: data.url,
                title: data.title || data.name, // Handle legacy 'name'
                artistName: data.artistName || '',
                coverImage: data.coverImage,
                registeredAt: data.registeredAt,
                lastSeen: data.lastSeen || Date.now(),
                _secure: isSecure
            };
        }

        function validateSite(site) {
            return site.url &&
                   isValidUrl(site.url) &&
                   site.title &&
                   site.title !== 'Untitled' &&
                   site.title !== 'TuneCamp Server' &&
                   site.title.trim() !== '';
        }

        // --- Rendering ---

        function renderSites() {
            // Deduplicate by title + artist
            const deduped = new Map();
            Array.from(sitesMap.values()).forEach(site => {
                const dedupKey = `${(site.title || '').toLowerCase()}::${(site.artistName || '').toLowerCase()}`;
                const existing = deduped.get(dedupKey);
                // Prefer secure, then more recent
                if (!existing ||
                    (site._secure && !existing._secure) ||
                    ((site.lastSeen || 0) > (existing.lastSeen || 0))) {
                    deduped.set(dedupKey, site);
                }
            });

            const sites = Array.from(deduped.values());
            sites.sort((a, b) => (b.lastSeen || 0) - (a.lastSeen || 0));

            if (currentTab === 'sites') updateCountDisplay();

            const grid = document.getElementById('sitesGrid');
            if (sites.length === 0) return;

            grid.innerHTML = sites.map(site => {
                const coverHtml = site.coverImage
                    ? `<img src="${escapeHtml(site.coverImage)}" alt="${escapeHtml(site.title)}" onerror="this.parentElement.innerHTML='üè†'">`
                    : 'üè†';

                const lastSeen = site.lastSeen ? formatDate(site.lastSeen) : 'Unknown';

                return `
                    <div class="site-card">
                        <div class="site-card-cover">${coverHtml}</div>
                        <div class="site-card-content">
                            <h3><a href="${escapeHtml(site.url)}" target="_blank">${escapeHtml(site.title)}</a></h3>
                            ${site.artistName ? `<div class="artist">by ${escapeHtml(site.artistName)}</div>` : ''}
                            <div class="meta">
                                <span>${site._secure ? 'üîê Verified' : 'üì° Discovered'}</span>
                                <span style="margin-left: auto">${lastSeen}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderTracks() {
            // Deduplicate Content (Same title + artist)
            const deduped = new Map();
            Array.from(tracksMap.values()).forEach(track => {
                const contentKey = `${track.title.toLowerCase()}::${track.artistName.toLowerCase()}`;
                // Keep only one entry per "content", prefer secure
                if (!deduped.has(contentKey) || track._secure) {
                    deduped.set(contentKey, track);
                }
            });

            const tracks = Array.from(deduped.values());
            // Sort by addedAt if available, or random/shuffle could be nice but let's stick to recent
            tracks.sort((a, b) => (b.addedAt || 0) - (a.addedAt || 0));

            if (currentTab === 'tracks') updateCountDisplay();

            const grid = document.getElementById('tracksGrid');
            if (tracks.length === 0) return;

            grid.innerHTML = tracks.map(track => {
                const coverHtml = track.coverUrl
                    ? `<img src="${escapeHtml(track.coverUrl)}" alt="${escapeHtml(track.title)}" onerror="this.parentElement.innerHTML='üéµ'">`
                    : 'üéµ';

                // Format duration
                const minutes = Math.floor(track.duration / 60);
                const seconds = Math.floor(track.duration % 60);
                const durationStr = track.duration ? `${minutes}:${seconds.toString().padStart(2, '0')}` : '';

                return `
                    <div class="track-card">
                        <div class="track-cover">
                            ${coverHtml}
                            <button class="play-btn" onclick="playTrack('${escapeHtml(track.audioUrl)}')" title="Play Preview">‚ñ∂</button>
                        </div>
                        <div class="track-info">
                            <div class="track-title" title="${escapeHtml(track.title)}">${escapeHtml(track.title)}</div>
                            <div class="track-artist" title="${escapeHtml(track.artistName)}">${escapeHtml(track.artistName)}</div>
                            <div class="track-meta">
                                <span>${durationStr}</span>
                                <span>‚Ä¢</span>
                                <a href="${escapeHtml(track.siteUrl)}" target="_blank" style="color: inherit; hover:text-decoration: underline;">${escapeHtml(track.siteTitle)}</a>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function playTrack(url) {
            // Simple audio player logic - stop others, play this
            if (window.currentAudio) {
                window.currentAudio.pause();
                window.currentAudio = null;
            }

            const audio = new Audio(url);
            audio.play();
            window.currentAudio = audio;

            // Visual feedback could be added here
        }

        function showEmptyState(gridId, message) {
            const grid = document.getElementById(gridId);
            if (grid.children.length <= 1 && grid.children[0]?.classList.contains('empty-state')) {
                 // Already showing empty state or spinner
                 // Update text if needed
            }
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 5) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;

            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;').replace(/'/g, '&#039;');
        }

        document.addEventListener('DOMContentLoaded', initDiscovery);
    </script>
</body>

</html>
